---
title: "Multinomial Regression"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  bookdown::html_document2:
    number_sections: no
    fig_caption: true
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: hide
header-includes:
- \usepackage{graphicx}
- \usepackage{float}
editor_options:
  chunk_output_type: inline
---

```{r setup knit, include=FALSE}
knitr::opts_chunk$set(
	fig.align = "center",
	fig.pos = "H",
	fig.width = 5,
	fig.height = 3,
	message = FALSE,
	warning = FALSE,
	external = TRUE,
	echo = TRUE
)

library(tidyverse)
library(magrittr)
library(ggsci)
library(kableExtra)

source("../R script/functions.R")
```


```{r data cleaning}
# load raw data files
data <- read.csv("../data/filledDatabase111119NUMONLY.csv")
# clean data 
data <- clean_data(data) %>% collapse_data()

# separate compound and group_cate from the predictors
compound <- data$Compound
group_cat <- data$GroupCat

# create data constructed by first 13 PC's
data <- select(data, -c("Compound","X"))
data_pca <- get_pc_space(data[,-1], k = 13) %>% scale() %>% data.frame() %>% bind_cols(GroupCat=group_cat)

# split data into 5 folds for cross validation later
folds <- caret::createFolds(1:nrow(data), k = 5, list = TRUE, returnTrain = FALSE)
```


```{r}
library(glmnet)
X = data[,-1] %>% as.matrix()
Y = data$GroupCat %>% as.matrix()
```





## Shrinkage {.tabset}

### Ridge

```{r}
model_ridge <- glmnet(x = X, y = Y, alpha = 0, family = "multinomial")
plot(model_ridge, xvar = "lambda", label = TRUE)
```

### LASSO

```{r}
model_lasso <- glmnet(x = X, y = Y, alpha = 1, family = "multinomial")
plot(model_lasso, xvar = "lambda", label = TRUE)
```





## Coefficients {.tabset}

### Ridge 

```{r fig.height=20, fig.width=10}
ridge_cv <- cv.glmnet(x = X, y = Y, alpha = 0, nfolds = 5, type.measure = "deviance", family = "multinomial")
ridge_cv %>% get_coef() %>% plot_coef()
```

### LASSO

```{r fig.height=20, fig.width=10}
lasso_cv <- cv.glmnet(x = X, y = Y, alpha = 1, nfolds = 5, type.measure = "deviance", family = "multinomial")
lasso_cv %>% get_coef() %>% plot_coef()
```



## Accurate classification rate {.tabset}

### Ridge

```{r}
tb_ridge = prediction_table(alpha = 0, lambda = ridge_cv$lambda.min) 
tb_ridge$r %>% print_accurate_tb()

tb_ridge$t %>% highlight_tb_count()
tb_ridge$t %>% highlight_tb_percent()
```




### LASSO

```{r}
tb_lasso = prediction_table(alpha = 1, lambda = lasso_cv$lambda.min) 
tb_lasso$r %>% print_accurate_tb()

tb_lasso$t %>% highlight_tb_count()
tb_lasso$t %>% highlight_tb_percent()
```




